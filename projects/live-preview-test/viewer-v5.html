<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Encrypted Preview v5</title>
  <style>
    *{margin:0;box-sizing:border-box}
    body{font:14px system-ui;background:#0d1117;color:#c9d1d9;min-height:100vh}
    .setup{max-width:400px;margin:40px auto;padding:20px}
    h2{color:#58a6ff;margin-bottom:8px}
    p{color:#8b949e;font-size:13px;margin-bottom:16px}
    label{display:block;color:#8b949e;font-size:12px;margin-bottom:4px}
    input{width:100%;padding:10px;margin-bottom:12px;background:#161b22;border:1px solid #30363d;color:#c9d1d9;border-radius:6px;font-size:14px}
    input:focus{outline:none;border-color:#58a6ff}
    button{width:100%;padding:12px;background:#238636;color:#fff;border:0;border-radius:6px;font-size:14px;cursor:pointer;font-weight:500}
    button:hover{background:#2ea043}
    button:disabled{background:#21262d;color:#484f58;cursor:not-allowed}
    .header{background:#161b22;padding:8px 16px;display:flex;align-items:center;gap:12px;border-bottom:1px solid #30363d}
    .dot{width:8px;height:8px;border-radius:50%;background:#3fb950}
    .dot.err{background:#f85149}
    .dot.load{background:#d29922}
    .status{flex:1;font-size:12px;color:#8b949e}
    .btn{background:#21262d;color:#c9d1d9;border:1px solid #30363d;padding:6px 12px;border-radius:6px;font-size:12px;cursor:pointer}
    .btn:hover{background:#30363d}
    iframe{width:100%;height:calc(100vh - 44px);border:0;background:#fff}
    .error{background:#f8514922;border:1px solid #f85149;color:#f85149;padding:12px;border-radius:6px;margin-top:12px;font-size:13px}
    .lock{font-size:32px;text-align:center;margin-bottom:16px}
  </style>
</head>
<body>
  <div id="setup" class="setup">
    <div class="lock">üîê</div>
    <h2>Encrypted Preview</h2>
    <p>Content is encrypted. Enter your Gist ID and password to view.</p>

    <label>Gist ID</label>
    <input type="text" id="gist" placeholder="abc123def456...">

    <label>Password</label>
    <input type="password" id="pass" placeholder="Enter decryption password">

    <button id="startBtn" onclick="start()">Decrypt & Watch</button>
    <div id="error" class="error" style="display:none"></div>
  </div>

  <div id="viewer" style="display:none">
    <div class="header">
      <div class="dot" id="dot"></div>
      <span class="status" id="status">Connecting...</span>
      <button class="btn" onclick="refresh()">Refresh</button>
      <button class="btn" onclick="stop()">Stop</button>
    </div>
    <iframe id="frame"></iframe>
  </div>

  <script>
    let gistId = '', password = '', lastContent = '', interval;

    // Check URL params
    const params = new URLSearchParams(location.search);
    if (params.get('g')) document.getElementById('gist').value = params.get('g');

    async function deriveKey(password, salt) {
      const enc = new TextEncoder();
      const keyMaterial = await crypto.subtle.importKey(
        'raw', enc.encode(password), 'PBKDF2', false, ['deriveBits', 'deriveKey']
      );
      return crypto.subtle.deriveKey(
        { name: 'PBKDF2', salt, iterations: 100000, hash: 'SHA-256' },
        keyMaterial,
        { name: 'AES-GCM', length: 256 },
        false,
        ['decrypt']
      );
    }

    async function decrypt(encryptedBase64, password) {
      try {
        const data = Uint8Array.from(atob(encryptedBase64), c => c.charCodeAt(0));

        // Parse: salt (16) + iv (12) + authTag (16) + ciphertext
        const salt = data.slice(0, 16);
        const iv = data.slice(16, 28);
        const authTag = data.slice(28, 44);
        const ciphertext = data.slice(44);

        // Combine ciphertext + authTag for Web Crypto (it expects them together)
        const combined = new Uint8Array(ciphertext.length + authTag.length);
        combined.set(ciphertext);
        combined.set(authTag, ciphertext.length);

        const key = await deriveKey(password, salt);
        const decrypted = await crypto.subtle.decrypt(
          { name: 'AES-GCM', iv },
          key,
          combined
        );

        return new TextDecoder().decode(decrypted);
      } catch (e) {
        throw new Error('Decryption failed - wrong password?');
      }
    }

    async function fetchAndRender() {
      const dot = document.getElementById('dot');
      const status = document.getElementById('status');
      dot.className = 'dot load';

      try {
        const res = await fetch('https://api.github.com/gists/' + gistId, {
          headers: { 'Accept': 'application/vnd.github.v3+json' },
          cache: 'no-store'
        });

        if (!res.ok) throw new Error('Fetch failed: ' + res.status);

        const data = await res.json();
        const files = data.files;
        const encrypted = files[Object.keys(files)[0]].content.trim();
        const rev = data.history[0].version.substring(0, 7);

        if (encrypted !== lastContent) {
          lastContent = encrypted;
          status.textContent = 'Decrypting...';

          const html = await decrypt(encrypted, password);
          document.getElementById('frame').srcdoc = html;
          status.textContent = 'Updated (rev: ' + rev + ') ' + new Date().toLocaleTimeString();
        } else {
          status.textContent = 'Watching (rev: ' + rev + ') ' + new Date().toLocaleTimeString();
        }
        dot.className = 'dot';
      } catch (e) {
        dot.className = 'dot err';
        status.textContent = 'Error: ' + e.message;
      }
    }

    async function start() {
      const btn = document.getElementById('startBtn');
      const errDiv = document.getElementById('error');
      errDiv.style.display = 'none';

      gistId = document.getElementById('gist').value.trim();
      password = document.getElementById('pass').value;

      // Extract ID if full URL pasted
      if (gistId.includes('github.com')) gistId = gistId.split('/').pop();
      if (gistId.includes('gist.githubusercontent')) gistId = gistId.split('/')[4];

      if (!gistId || !password) {
        errDiv.textContent = 'Please enter both Gist ID and password';
        errDiv.style.display = 'block';
        return;
      }

      btn.disabled = true;
      btn.textContent = 'Connecting...';

      try {
        // Test fetch and decrypt
        const res = await fetch('https://api.github.com/gists/' + gistId, {
          cache: 'no-store'
        });
        if (!res.ok) throw new Error('Gist not found');

        const data = await res.json();
        const encrypted = data.files[Object.keys(data.files)[0]].content.trim();

        // Test decryption
        await decrypt(encrypted, password);

        // Success - switch to viewer
        history.replaceState({}, '', '?g=' + gistId);
        document.getElementById('setup').style.display = 'none';
        document.getElementById('viewer').style.display = 'block';

        fetchAndRender();
        interval = setInterval(fetchAndRender, 3000);
      } catch (e) {
        errDiv.textContent = e.message;
        errDiv.style.display = 'block';
        btn.disabled = false;
        btn.textContent = 'Decrypt & Watch';
      }
    }

    function stop() {
      clearInterval(interval);
      lastContent = '';
      document.getElementById('setup').style.display = 'block';
      document.getElementById('viewer').style.display = 'none';
      document.getElementById('startBtn').disabled = false;
      document.getElementById('startBtn').textContent = 'Decrypt & Watch';
    }

    function refresh() {
      lastContent = '';
      fetchAndRender();
    }
  </script>
</body>
</html>
