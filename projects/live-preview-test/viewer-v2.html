<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>CC Web Live Preview</title>
  <style>
    *{margin:0;box-sizing:border-box}
    body{font:14px system-ui;background:#1a1a2e;color:#eee}
    .h{background:#16213e;padding:8px 12px;display:flex;align-items:center;gap:8px;border-bottom:1px solid #0f3460}
    .d{width:8px;height:8px;border-radius:50%;background:#4ade80;flex-shrink:0}
    .d.err{background:#f87171}
    .d.load{background:#fbbf24}
    .status{flex:1;font-size:12px;opacity:0.8}
    input{flex:1;padding:8px;background:#0f3460;border:1px solid #234;color:#eee;border-radius:4px;font-size:14px}
    button{background:#0f3460;color:#eee;border:0;padding:8px 16px;border-radius:4px;cursor:pointer}
    button:hover{background:#1a4a7a}
    iframe{width:100%;height:calc(100vh - 52px);border:0;background:#fff}
    .setup{max-width:500px;margin:40px auto;padding:20px}
    .setup h1{margin-bottom:8px}
    .setup p{color:#888;font-size:13px;margin-bottom:16px}
    .info{background:#0f3460;padding:16px;border-radius:8px;margin-top:20px}
    .info p{margin:4px 0}
    code{background:#16213e;padding:2px 6px;border-radius:3px;font-size:12px}
  </style>
</head>
<body>
  <div id="setup" class="setup">
    <h1>CC Web Live Preview v2</h1>
    <p>Enter the raw Gist URL containing your HTML content:</p>
    <input type="text" id="gist-url" placeholder="https://gist.githubusercontent.com/...">
    <button onclick="start()" style="width:100%;margin-top:12px;padding:12px">Start Watching</button>
    <div class="info">
      <p><strong>New in v2:</strong> Direct HTML rendering</p>
      <p>Store raw HTML in Gist instead of itty.bitty URLs</p>
    </div>
  </div>

  <div id="viewer" style="display:none">
    <div class="h">
      <div class="d" id="dot"></div>
      <span class="status" id="status">Connecting...</span>
      <button onclick="refresh()">Refresh</button>
      <button onclick="newTab()">New Tab</button>
      <button onclick="stop()">Stop</button>
    </div>
    <iframe id="frame" sandbox="allow-scripts"></iframe>
  </div>

  <script>
    let interval, gistUrl, lastContent = '', lastHtml = '';

    const $ = id => document.getElementById(id);

    // Check URL param
    const param = new URLSearchParams(location.search).get('g');
    if (param) $('gist-url').value = param;

    async function check() {
      $('dot').className = 'd load';
      try {
        const res = await fetch(gistUrl + '?t=' + Date.now());
        if (!res.ok) throw new Error('Fetch failed');
        const content = await res.text();

        if (content !== lastContent) {
          lastContent = content;

          // Check if it's an itty.bitty URL or raw HTML
          if (content.trim().startsWith('https://itty.bitty')) {
            // Extract and decode the base64 LZMA content
            const hash = content.split('#/')[1];
            if (hash) {
              // For now, open in new tab since LZMA decoding needs library
              $('frame').src = content.trim();
              lastHtml = content.trim();
            }
          } else {
            // Raw HTML - render directly
            lastHtml = content;
            $('frame').srcdoc = content;
          }
          $('status').textContent = 'Updated ' + new Date().toLocaleTimeString();
        } else {
          $('status').textContent = 'Watching... ' + new Date().toLocaleTimeString();
        }
        $('dot').className = 'd';
      } catch (e) {
        $('dot').className = 'd err';
        $('status').textContent = 'Error: ' + e.message;
      }
    }

    function start() {
      gistUrl = $('gist-url').value.trim();
      if (!gistUrl) return alert('Enter a Gist URL');

      history.replaceState({}, '', '?g=' + encodeURIComponent(gistUrl));
      $('setup').style.display = 'none';
      $('viewer').style.display = 'block';

      check();
      interval = setInterval(check, 2000);
    }

    function stop() {
      clearInterval(interval);
      $('setup').style.display = 'block';
      $('viewer').style.display = 'none';
      lastContent = '';
    }

    function refresh() {
      lastContent = '';
      check();
    }

    function newTab() {
      if (lastHtml.startsWith('http')) {
        window.open(lastHtml, '_blank');
      } else {
        const blob = new Blob([lastHtml], {type: 'text/html'});
        window.open(URL.createObjectURL(blob), '_blank');
      }
    }

    if (param) start();
  </script>
</body>
</html>
