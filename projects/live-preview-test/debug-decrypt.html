<!DOCTYPE html>
<html>
<head><title>Decrypt Debug</title></head>
<body>
<h2>Decrypt Debug</h2>
<pre id="log"></pre>
<script>
const log = (msg) => { document.getElementById('log').textContent += msg + '\n'; console.log(msg); };

async function test() {
  const gistId = 'c1a64976eacb07e222835983604e35b3';
  const password = 'preview123';

  log('Fetching gist...');
  const res = await fetch('https://api.github.com/gists/' + gistId);
  const data = await res.json();
  const content = data.files[Object.keys(data.files)[0]].content.trim();

  log('Content length: ' + content.length);
  log('First 50 chars: ' + content.substring(0, 50));

  try {
    const bytes = Uint8Array.from(atob(content), c => c.charCodeAt(0));
    log('Decoded bytes: ' + bytes.length);

    const salt = bytes.slice(0, 16);
    const iv = bytes.slice(16, 28);
    const authTag = bytes.slice(28, 44);
    const ciphertext = bytes.slice(44);

    log('Salt: ' + salt.length + ' bytes');
    log('IV: ' + iv.length + ' bytes');
    log('AuthTag: ' + authTag.length + ' bytes');
    log('Ciphertext: ' + ciphertext.length + ' bytes');

    // Derive key
    const enc = new TextEncoder();
    const keyMaterial = await crypto.subtle.importKey(
      'raw', enc.encode(password), 'PBKDF2', false, ['deriveBits', 'deriveKey']
    );
    const key = await crypto.subtle.deriveKey(
      { name: 'PBKDF2', salt, iterations: 100000, hash: 'SHA-256' },
      keyMaterial,
      { name: 'AES-GCM', length: 256 },
      false,
      ['decrypt']
    );
    log('Key derived successfully');

    // Web Crypto expects ciphertext + authTag concatenated
    const combined = new Uint8Array(ciphertext.length + authTag.length);
    combined.set(ciphertext);
    combined.set(authTag, ciphertext.length);
    log('Combined for decrypt: ' + combined.length + ' bytes');

    const decrypted = await crypto.subtle.decrypt(
      { name: 'AES-GCM', iv },
      key,
      combined
    );

    const text = new TextDecoder().decode(decrypted);
    log('SUCCESS! Decrypted: ' + text.substring(0, 100) + '...');
  } catch (e) {
    log('ERROR: ' + e.message);
    log('Stack: ' + e.stack);
  }
}

test();
</script>
</body>
</html>
