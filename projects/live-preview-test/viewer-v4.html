<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Preview v4</title>
  <style>
    body{font:14px system-ui;background:#111;color:#eee;padding:16px}
    input{width:100%;padding:12px;margin:8px 0;background:#222;border:1px solid #444;color:#eee;border-radius:4px;font-size:14px}
    button{width:100%;padding:12px;background:#4ade80;color:#000;border:0;border-radius:4px;font-size:14px;cursor:pointer;margin-top:8px}
    #log{background:#222;padding:12px;margin:16px 0;border-radius:4px;font-family:monospace;font-size:11px;max-height:120px;overflow:auto}
    iframe{width:100%;height:55vh;border:1px solid #444;background:#fff;margin-top:16px}
    small{color:#888}
  </style>
</head>
<body>
  <h3>CC Web Preview v4</h3>
  <small>Uses GitHub API to avoid CDN caching</small>
  <input type="text" id="gist" placeholder="Gist ID (e.g. c1a64976eacb07e222835983604e35b3)">
  <button onclick="go()">Start</button>
  <div id="log">Ready. Enter Gist ID and click Start.</div>
  <iframe id="f"></iframe>

  <script>
    var log = function(msg) {
      var el = document.getElementById('log');
      el.innerHTML += '<br>' + msg;
      el.scrollTop = el.scrollHeight;
    };

    var lastContent = '';
    var gistId = '';

    async function fetchAndRender() {
      // Use GitHub API - no caching issues
      var apiUrl = 'https://api.github.com/gists/' + gistId;
      log('Fetching API...');

      try {
        var res = await fetch(apiUrl, {
          headers: { 'Accept': 'application/vnd.github.v3+json' },
          cache: 'no-store'
        });
        log('Status: ' + res.status);

        if (!res.ok) {
          log('Error: ' + res.statusText);
          return;
        }

        var data = await res.json();
        var files = data.files;
        var filename = Object.keys(files)[0];
        var html = files[filename].content;

        log('Got ' + html.length + ' chars (rev: ' + data.history[0].version.substring(0,7) + ')');

        if (html !== lastContent) {
          lastContent = html;
          document.getElementById('f').srcdoc = html;
          log('âœ“ Updated!');
        }
      } catch (e) {
        log('Error: ' + e.message);
      }
    }

    var interval;
    function go() {
      gistId = document.getElementById('gist').value.trim();
      // Extract ID if full URL pasted
      if (gistId.includes('github.com')) {
        gistId = gistId.split('/').pop();
      }
      if (gistId.includes('gist.githubusercontent')) {
        gistId = gistId.split('/')[4];
      }

      if (!gistId) {
        alert('Enter a Gist ID');
        return;
      }
      log('Using Gist: ' + gistId);
      fetchAndRender();
      interval = setInterval(fetchAndRender, 3000);
      log('Polling every 3s via API');
    }
  </script>
</body>
</html>
