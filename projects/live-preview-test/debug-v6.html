<!DOCTYPE html>
<html>
<head>
  <title>Debug v6</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/forge/0.10.0/forge.min.js"></script>
</head>
<body>
<h2>Debug v6</h2>
<pre id="log"></pre>
<script>
const log = (msg) => {
  document.getElementById('log').textContent += msg + '\n';
  console.log(msg);
};

async function test() {
  const gistId = 'c1a64976eacb07e222835983604e35b3';
  const password = 'preview123';

  log('Checking forge...');
  if (typeof forge === 'undefined') {
    log('ERROR: forge not loaded!');
    return;
  }
  log('forge loaded OK');

  log('Fetching gist...');
  try {
    const res = await fetch('https://api.github.com/gists/' + gistId);
    const data = await res.json();
    const content = data.files[Object.keys(data.files)[0]].content.trim();

    log('Content length: ' + content.length);
    log('First 50: ' + content.substring(0, 50));

    log('Decoding base64...');
    const decoded = forge.util.decode64(content);
    log('Decoded length: ' + decoded.length);

    const salt = decoded.substring(0, 16);
    const iv = decoded.substring(16, 28);
    const authTag = decoded.substring(28, 44);
    const ciphertext = decoded.substring(44);

    log('Salt len: ' + salt.length);
    log('IV len: ' + iv.length);
    log('AuthTag len: ' + authTag.length);
    log('Ciphertext len: ' + ciphertext.length);

    log('Deriving key (this takes a few seconds)...');
    const key = forge.pkcs5.pbkdf2(password, salt, 100000, 32, 'sha256');
    log('Key derived, length: ' + key.length);

    log('Creating decipher...');
    const decipher = forge.cipher.createDecipher('AES-GCM', key);

    log('Starting decipher...');
    decipher.start({
      iv: iv,
      tag: forge.util.createBuffer(authTag)
    });

    log('Updating with ciphertext...');
    decipher.update(forge.util.createBuffer(ciphertext));

    log('Finishing...');
    const result = decipher.finish();
    log('Finish result: ' + result);

    if (result) {
      const plaintext = decipher.output.toString('utf8');
      log('SUCCESS! Decrypted length: ' + plaintext.length);
      log('First 200 chars: ' + plaintext.substring(0, 200));
    } else {
      log('ERROR: Authentication failed');
    }
  } catch (e) {
    log('ERROR: ' + e.message);
    log('Stack: ' + e.stack);
  }
}

// Wait for forge to load
if (typeof forge !== 'undefined') {
  test();
} else {
  window.onload = test;
}
</script>
</body>
</html>
