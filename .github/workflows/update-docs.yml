name: Update Docs

on:
  # Auto-trigger on all PRs
  pull_request:
    types: [opened, synchronize]
  # Manual trigger via PR comment: /update-docs [optional instructions]
  issue_comment:
    types: [created]
  # Manual trigger via Actions tab
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to analyze (required when running on main)'
        required: false
        type: number
      additional_instructions:
        description: 'Additional instructions for the agent'
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write
  id-token: write

jobs:
  update-docs:
    runs-on: ubuntu-latest
    # Run if: PR with matching paths, OR /update-docs comment on PR, OR manual dispatch
    if: |
      github.event_name == 'pull_request' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issue_comment' &&
       github.event.issue.pull_request &&
       startsWith(github.event.comment.body, '/update-docs'))
    steps:
      - name: Get PR branch (for comment trigger)
        id: pr-branch
        if: github.event_name == 'issue_comment'
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            core.setOutput('branch', pr.data.head.ref);

      - name: Get PR info (for workflow_dispatch with pr_number)
        id: pr-info
        if: github.event_name == 'workflow_dispatch' && inputs.pr_number
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: ${{ inputs.pr_number || 0 }}
            });
            core.setOutput('branch', pr.data.head.ref);
            core.setOutput('base', pr.data.base.ref);
            core.setOutput('head_sha', pr.data.head.sha);

      - name: Extract instructions from comment
        id: comment-instructions
        if: github.event_name == 'issue_comment'
        run: |
          COMMENT="${{ github.event.comment.body }}"
          INSTRUCTIONS="${COMMENT#/update-docs}"
          INSTRUCTIONS="${INSTRUCTIONS#"${INSTRUCTIONS%%[![:space:]]*}"}"
          echo "instructions<<EOF" >> $GITHUB_OUTPUT
          echo "$INSTRUCTIONS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Checkout branch
        uses: actions/checkout@v5
        with:
          ref: ${{ steps.pr-info.outputs.head_sha || steps.pr-branch.outputs.branch || github.head_ref || github.ref }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create AGENTS.override.md for automated execution
        run: |
          cat > AGENTS.override.md << 'EOF'
          # Automated Workflow Override

          This is an automated CI/CD workflow. Execute all instructions directly:
          - Do NOT ask for confirmation or approval
          - Do NOT output "Shall I proceed?" or similar questions
          - Do NOT wait for human input
          - Complete the task autonomously and exit

          Follow the prompt instructions exactly. Execute all steps immediately.
          EOF

      - name: Update docs with Codex
        uses: openai/codex-action@v1
        env:
          ADDITIONAL_INSTRUCTIONS: ${{ steps.comment-instructions.outputs.instructions || inputs.additional_instructions || '' }}
          BASE_REF: ${{ steps.pr-info.outputs.base || 'main' }}
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          sandbox: workspace-write
          prompt: |
            IMPORTANT: Execute all steps directly. Do not ask for confirmation or approval.

            Task: Keep documentation up to date based on pull request changes.

            ## Additional Instructions

            ${{ env.ADDITIONAL_INSTRUCTIONS }}

            ## Documentation Structure

            This project separates agent behavior from project knowledge. Route content correctly:

            | Document | Purpose | Content Type |
            |----------|---------|--------------|
            | AGENTS.md | How agents should behave | Workflow rules, boundaries, completion criteria |
            | README.md | Project overview for humans | Structure, commands, env vars, getting started |
            | CONTRIBUTING.md | How to contribute code | Code style, git workflow, PR process |
            | docs/*.md | Deep-dive guides | Deployment, CC Web, browser automation |

            **Entry points:** README.md is the homepage for humans; AGENTS.md is the homepage for AI agents.

            **Navigation:** Docs should link to each other like pages on a website. No dead ends.

            ## Step 1: Analyze changes

            Run: git diff origin/${{ env.BASE_REF }}...HEAD --name-only

            Understand what changed in this PR.

            ## Step 2: Update relevant documentation

            Based on the changes, update the appropriate docs following the structure above:

            ### README.md (Project Knowledge)
            - Update project/package descriptions if they changed
            - Add new projects or packages if created
            - Update project structure section if directories added/removed
            - Update commands section if build/test commands changed
            - Update environment setup if new env vars required
            - Keep descriptions to 2-3 sentences with key technologies

            ### AGENTS.md (Agent Behavior)
            - Update workflow instructions if agent processes changed
            - Update boundaries section if new rules apply
            - Update completion criteria if requirements changed
            - Do NOT put project structure, commands, or env vars here (those go in README.md)

            ### CONTRIBUTING.md (Code Style)
            - Update code style guidelines if conventions changed
            - Update git workflow instructions if process changed
            - Update PR process if requirements changed

            ### docs/learnings-log.md
            - Add new entries for significant discoveries or gotchas found during the PR
            - Document any non-obvious solutions or workarounds
            - Include date headers (YYYY-MM format)
            - Keep entries concise but informative for future reference

            ### Other docs (docs/*.md)
            - Update architecture docs if system design changed
            - Update deployment docs if deploy process changed
            - Update package docs if package APIs changed

            ## Step 2.5: Maintain Cross-References

            Documentation should work like a website with clear navigation. After updating any doc:

            ### Check and update links

            1. **Add "See Also" sections** - Every doc in `docs/` should end with related links:
               ```markdown
               ## See Also
               - [README.md](../README.md) - Project overview
               - [Related Doc](./related.md) - When you also need X
               ```

            2. **Link sideways to related docs** - Connect docs often used together:
               - `browserless.md` ↔ `cc-web.md` (browser automation in sandboxed env)
               - `static-html-guide.md` ↔ `vercel-deployment.md` (deployment options)
               - New feature docs → existing docs they depend on

            3. **Update entry point indexes** when adding new docs:
               - Add to `README.md` Documentation table
               - Add to `AGENTS.md` References table (if agents need it)

            4. **Anticipate reader needs** - If someone reading doc A will likely need doc B next, add a link

            ### Cross-reference checklist

            For each doc you modify or create:
            - [ ] Does it link back to README.md?
            - [ ] Does it link to related docs in `docs/`?
            - [ ] Is it listed in README.md's Documentation table?
            - [ ] If agent-relevant, is it in AGENTS.md's References table?
            - [ ] Do related existing docs link to this new/updated doc?

            ### Navigation principle

            A reader should never hit a dead end. From any doc, they should find their way to related information or back to an entry point.

            ## Step 3: Commit changes

            If you made documentation changes, commit them:
            git add README.md AGENTS.md CONTRIBUTING.md docs/ && git commit -m "docs: update documentation for PR changes"

            ## Rules

            - Be concise and factual
            - Preserve existing document structure
            - Only update docs that are affected by the PR changes
            - Skip if documentation is already accurate
            - Do not add speculative or placeholder content
            - Follow the documentation structure: agent behavior in AGENTS.md, project knowledge in README.md
            - Maintain cross-references: every doc should link to related docs and back to entry points
            - No orphan docs: new docs must be linked from README.md and/or AGENTS.md

      - name: Cleanup override file
        run: rm -f AGENTS.override.md

      - name: Push changes
        run: |
          # Check if there are any commits to push
          if [ -z "$(git log origin/${{ github.ref_name }}..HEAD 2>/dev/null)" ]; then
            echo "No changes to push"
            exit 0
          fi

          BRANCH="${{ steps.pr-info.outputs.branch || steps.pr-branch.outputs.branch || github.head_ref || github.ref_name }}"

          # If triggered manually on main without pr_number, create a new branch
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "$BRANCH" = "main" ]; then
            NEW_BRANCH="docs/update-$(date +%Y%m%d-%H%M%S)"
            git checkout -b "$NEW_BRANCH"
            git push -u origin "$NEW_BRANCH"
            echo "::notice::Branch $NEW_BRANCH created. Create PR at: https://github.com/${{ github.repository }}/pull/new/$NEW_BRANCH"
          else
            git push origin HEAD:${BRANCH}
          fi
