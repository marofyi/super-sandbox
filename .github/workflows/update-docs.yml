name: Update Docs

on:
  pull_request:
    types: [opened]
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to update docs on (defaults to current branch)'
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write
  id-token: write

jobs:
  update-docs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout branch
        uses: actions/checkout@v5
        with:
          ref: ${{ github.head_ref || inputs.branch || github.ref }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create AGENTS.override.md for automated execution
        run: |
          cat > AGENTS.override.md << 'EOF'
          # Automated Workflow Override

          This is an automated CI/CD workflow. Execute all instructions directly:
          - Do NOT ask for confirmation or approval
          - Do NOT output "Shall I proceed?" or similar questions
          - Do NOT wait for human input
          - Complete the task autonomously and exit

          Follow the prompt instructions exactly. Execute all steps immediately.
          EOF

      - name: Update docs with Codex
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          sandbox: workspace-write
          prompt: |
            IMPORTANT: Execute all steps directly. Do not ask for confirmation or approval.

            Task: Keep documentation up to date based on pull request changes.

            ## Documentation Structure

            This project separates agent behavior from project knowledge. Route content correctly:

            | Document | Purpose | Content Type |
            |----------|---------|--------------|
            | AGENTS.md | How agents should behave | Workflow rules, boundaries, completion criteria |
            | README.md | Project overview for humans | Structure, commands, env vars, getting started |
            | CONTRIBUTING.md | How to contribute code | Code style, git workflow, PR process |
            | docs/*.md | Deep-dive guides | Deployment, CC Web, browser automation |
            | .skills/*/SKILL.md | Agent capabilities | Step-by-step procedures for specific tasks |

            ## Step 1: Analyze changes

            Run: git diff origin/main...HEAD --name-only

            Understand what changed in this PR.

            ## Step 2: Update relevant documentation

            Based on the changes, update the appropriate docs following the structure above:

            ### README.md (Project Knowledge)
            - Update project/package descriptions if they changed
            - Add new projects or packages if created
            - Update project structure section if directories added/removed
            - Update commands section if build/test commands changed
            - Update environment setup if new env vars required
            - Keep descriptions to 2-3 sentences with key technologies

            ### AGENTS.md (Agent Behavior)
            - Update workflow instructions if agent processes changed
            - Update boundaries section if new rules apply
            - Update completion criteria if requirements changed
            - **Maintain Agent Skills table**: If skills in `.skills/` were added, removed, or modified:
              - Read each `.skills/*/SKILL.md` file to extract `name`, `description`, and `allowed-tools` from YAML frontmatter
              - Update the "Agent Skills" table to reflect current skills
              - Keep table sorted alphabetically by skill name
              - Link each skill name to its SKILL.md file
            - Do NOT put project structure, commands, or env vars here (those go in README.md)

            ### CONTRIBUTING.md (Code Style)
            - Update code style guidelines if conventions changed
            - Update git workflow instructions if process changed
            - Update PR process if requirements changed

            ### docs/learnings-log.md
            - Add new entries for significant discoveries or gotchas found during the PR
            - Document any non-obvious solutions or workarounds
            - Include date headers (YYYY-MM format)
            - Keep entries concise but informative for future reference

            ### Other docs (docs/*.md)
            - Update architecture docs if system design changed
            - Update deployment docs if deploy process changed
            - Update package docs if package APIs changed

            ### projects/index.html (Project Landing Page)
            If projects were added, removed, or modified:
            - Scan `projects/` for subdirectories with `package.json` (full projects)
            - Scan `projects/` for standalone `.html` files (prototypes, excluding index.html)
            - For each project, extract:
              - **Title**: from package.json `name` field or HTML `<title>` tag
              - **Description**: from package.json `description` or first paragraph in README.md
              - **Live URL**: from existing Vercel deployments or relative path for static HTML
              - **Type**: "Web Application", "CLI Tool", or "Prototype"
            - Update the HTML cards in the appropriate section (Web Applications, CLI Tools, Prototypes)
            - Preserve the existing HTML structure and Tailwind CSS classes
            - Add new project cards following the existing card template pattern
            - Remove cards for deleted projects

            ## Step 3: Commit changes

            If you made documentation changes, commit them:
            git add README.md AGENTS.md CONTRIBUTING.md docs/ projects/index.html && git commit -m "docs: update documentation for PR changes"

            ## Rules

            - Be concise and factual
            - Preserve existing document structure
            - Only update docs that are affected by the PR changes
            - Skip if documentation is already accurate
            - Do not add speculative or placeholder content
            - Follow the documentation structure: agent behavior in AGENTS.md, project knowledge in README.md

      - name: Cleanup override file
        run: rm -f AGENTS.override.md

      - name: Push changes
        run: |
          BRANCH="${{ github.head_ref || inputs.branch || github.ref_name }}"
          if [ -n "$(git log origin/${BRANCH}..HEAD 2>/dev/null)" ]; then
            git push origin HEAD:${BRANCH}
          fi
