name: Update Projects Index

on:
  # Auto-trigger when new projects are added
  pull_request:
    types: [opened, synchronize]
    paths:
      - 'projects/**/package.json'
  # Manual trigger via PR comment: /update-index [optional instructions]
  issue_comment:
    types: [created]
  # Manual trigger via Actions tab
  workflow_dispatch:
    inputs:
      additional_instructions:
        description: 'Additional instructions for the agent'
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write
  id-token: write

jobs:
  update-index:
    runs-on: ubuntu-latest
    # Run if: PR with matching paths, OR /update-index comment on PR, OR manual dispatch
    if: |
      github.event_name == 'pull_request' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issue_comment' &&
       github.event.issue.pull_request &&
       startsWith(github.event.comment.body, '/update-index'))
    steps:
      - name: Get PR branch (for comment trigger)
        id: pr-branch
        if: github.event_name == 'issue_comment'
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            core.setOutput('branch', pr.data.head.ref);

      - name: Extract instructions from comment
        id: comment-instructions
        if: github.event_name == 'issue_comment'
        run: |
          COMMENT="${{ github.event.comment.body }}"
          INSTRUCTIONS="${COMMENT#/update-index}"
          INSTRUCTIONS="${INSTRUCTIONS#"${INSTRUCTIONS%%[![:space:]]*}"}"
          echo "instructions<<EOF" >> $GITHUB_OUTPUT
          echo "$INSTRUCTIONS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Checkout branch
        uses: actions/checkout@v5
        with:
          ref: ${{ steps.pr-branch.outputs.branch || github.head_ref || github.ref }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create AGENTS.override.md for automated execution
        run: |
          cat > AGENTS.override.md << 'EOF'
          # Automated Workflow Override

          This is an automated CI/CD workflow. Execute all instructions directly:
          - Do NOT ask for confirmation or approval
          - Do NOT output "Shall I proceed?" or similar questions
          - Do NOT wait for human input
          - Complete the task autonomously and exit

          Follow the prompt instructions exactly. Execute all steps immediately.
          EOF

      - name: Update projects index with Codex
        uses: openai/codex-action@v1
        env:
          ADDITIONAL_INSTRUCTIONS: ${{ steps.comment-instructions.outputs.instructions || inputs.additional_instructions || '' }}
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          sandbox: workspace-write
          prompt: |
            IMPORTANT: Execute all steps directly. Do not ask for confirmation or approval.

            Task: Update projects/index.html to reflect changes in the projects folder.

            ## Additional Instructions

            ${{ env.ADDITIONAL_INSTRUCTIONS }}

            ## Step 1: Analyze project changes

            Run: git diff origin/main...HEAD --name-only -- projects/

            Understand what projects were added, modified, or removed.

            ## Step 2: Update projects/index.html

            Scan the projects folder and update the index.html landing page:

            - Scan `projects/` for subdirectories with `package.json` (full projects)
            - Scan `projects/` for standalone `.html` files (prototypes, excluding index.html)
            - For each project, extract:
              - **Title**: from package.json `name` field or HTML `<title>` tag
              - **Description**: from package.json `description` or first paragraph in README.md
              - **Live URL**: from existing Vercel deployments or relative path for static HTML
              - **Type**: "Web Application", "CLI Tool", or "Prototype"
            - Update the HTML cards in the appropriate section (Web Applications, CLI Tools, Prototypes)
            - Preserve the existing HTML structure and Tailwind CSS classes
            - Add new project cards following the existing card template pattern
            - Remove cards for deleted projects

            ## Step 3: Commit changes

            If you made changes, commit them:
            git add projects/index.html && git commit -m "docs: update projects index"

            ## Rules

            - Be concise and factual
            - Preserve existing HTML structure and styling
            - Only update if projects were actually added, removed, or modified
            - Skip if index.html is already accurate
            - Do not add speculative or placeholder content

      - name: Cleanup override file
        run: rm -f AGENTS.override.md

      - name: Push changes
        run: |
          # Check if there are any commits to push
          if [ -z "$(git log origin/${{ github.ref_name }}..HEAD 2>/dev/null)" ]; then
            echo "No changes to push"
            exit 0
          fi

          BRANCH="${{ steps.pr-branch.outputs.branch || github.head_ref || github.ref_name }}"

          # If triggered manually on main, create a new branch
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "$BRANCH" = "main" ]; then
            NEW_BRANCH="docs/update-index-$(date +%Y%m%d-%H%M%S)"
            git checkout -b "$NEW_BRANCH"
            git push -u origin "$NEW_BRANCH"
            echo "::notice::Branch $NEW_BRANCH created. Create PR at: https://github.com/${{ github.repository }}/pull/new/$NEW_BRANCH"
          else
            git push origin HEAD:${BRANCH}
          fi
