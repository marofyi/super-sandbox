name: Update README

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: write
  pull-requests: write
  id-token: write

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Update README with Codex
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          sandbox: workspace-write
          prompt: |
            Analyze all changes in this PR by running: git diff origin/main...HEAD --name-only

            Update README.md to reflect the current state of the repository:

            1. **Projects** (projects/): List each project with a 2-3 sentence summary and key technologies
            2. **Packages** (packages/): List shared packages with their purpose
            3. **Configuration**: Note any significant config changes (.github/, .claude/, etc.)

            Guidelines:
            - Keep descriptions concise and factual
            - Sort items by most recently modified
            - Skip hidden folders and generated files
            - Preserve existing README structure where possible
            - Only update sections relevant to the changed files

            If the README already accurately reflects the changes, do not modify it.
            If updates are needed, stage and commit with message "docs: update README for PR changes".

      - name: Push changes
        run: |
          if [ -n "$(git log origin/${{ github.head_ref }}..HEAD)" ]; then
            git push origin HEAD:${{ github.head_ref }}
          fi
